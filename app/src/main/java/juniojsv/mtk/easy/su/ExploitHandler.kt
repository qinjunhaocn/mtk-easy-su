package juniojsv.mtk.easy.su

import android.content.Context
import android.content.SharedPreferences
import android.util.Log
import java.io.File
import java.io.FileOutputStream

data class ExploitResult(val isSuccessful: Boolean, val log: String)

class ExploitHandler(
    private val context: Context,
    onPostExecute: (result: ExploitResult) -> Unit
) : CoroutineTask<ExploitResult>(onPostExecute) {

    private val preferences: SharedPreferences =
        context.getSharedPreferences(BuildConfig.APPLICATION_ID, Context.MODE_PRIVATE)

    override fun onPreExecute() {
        // 设置全局标志，表示Exploit正在运行
        isExploitRunning = true
        Log.d("ExploitHandler", "onPreExecute: Exploit execution started")
        context.getString(R.string.executing_script).toast(context, true)
    }

    override fun doInBackground(): ExploitResult {
        val log = StringBuilder("Mtk-easy-su ${BuildConfig.VERSION_NAME}\n")
        val files = arrayListOf<File>()
        Log.d("ExploitHandler", "doInBackground: Starting execution")
        with(context) {
            File(filesDir.absoluteFile, "64").mkdir()
            File(filesDir.absoluteFile, "32").mkdir()
            Log.d("ExploitHandler", "doInBackground: Created 32 and 64 directories")
            Log.d("ExploitHandler", "doInBackground: Processing assets")
            assets?.list("")?.forEach { name ->
                Log.d("ExploitHandler", "doInBackground: Processing asset: $name")
                when (name) {
                    "magisk-boot.sh", "magiskinit32", "magiskinit64", "mtk-su32", "mtk-su64" -> {
                        try {
                            val file: File =
                                when {
                                    name.endsWith("32") -> File(
                                        File("${filesDir.absolutePath}/32"),
                                        name.removeSuffix("32")
                                    )
                                    name.endsWith("64") -> File(
                                        File("${filesDir.absolutePath}/64"),
                                        name.removeSuffix("64")
                                    )
                                    else -> File(filesDir.absoluteFile, name)
                                }
                            Log.d("ExploitHandler", "doInBackground: Creating file: ${file.absolutePath}")
                            val output = FileOutputStream(file)
                            assets.open(name).copyTo(output, 512)
                            output.close()
                            Runtime.getRuntime().exec("chmod 510 ${file.absolutePath}")
                                .waitFor()
                            files.add(file)
                            file.exists().let { success ->
                                if (success) {
                                    log.append("extracted ${file.toRelativeString(context.filesDir)}\n")
                                    Log.d("ExploitHandler", "doInBackground: Successfully extracted: ${file.toRelativeString(context.filesDir)}")
                                }
                            }
                            // Added by KoCleo
                            Log.d("ExploitHandler", "doInBackground: Checking if Magisk Manager is installed")
                            val packageManager = context.packageManager
                            val isMagiskManagerInstalled = try {
                                packageManager.getPackageInfo("com.topjohnwu.magisk", 0)
                                Log.d("ExploitHandler", "doInBackground: Magisk Manager is installed")
                                true
                            } catch (e: Exception) {
                                Log.d("ExploitHandler", "doInBackground: Magisk Manager is not installed")
                                false
                            }
                            if (!isMagiskManagerInstalled) {
                                Log.d("ExploitHandler", "doInBackground: Magisk Manager not installed, extracting APK")
                                val targetDir = context.getExternalFilesDir(null) ?: context.filesDir
                                val apkFile = File(targetDir, "magisk-manager.apk")
                                Log.d("ExploitHandler", "doInBackground: Target APK file path: ${apkFile.absolutePath}")
                                try {
                                    context.assets.open("magisk-manager.apk").use { input ->
                                        FileOutputStream(apkFile).use { output ->
                                            input.copyTo(output)
                                        }
                                    }
                                    log.append("APK extracted to ${apkFile.absolutePath}\n")
                                    Log.d("ExploitHandler", "doInBackground: APK extracted successfully")
                                } catch (e: Exception) {
                                    Log.e("ExploitHandler", "doInBackground: Failed to extract APK", e)
                                    log.append("Failed to extract APK: ${e.message}\n")
                                }
                            } else {
                                log.append("Magisk Manager already installed, skipping APK extraction.\n")
                                Log.d("ExploitHandler", "doInBackground: Magisk Manager already installed, skipping APK extraction")
                            }
                            // Added by KoCleo
                        } catch (e: Exception) {
                            log.append(e.message)
                            Log.e("ExploitHandler", "doInBackground: Exception occurred", e)
                        }
                    }
                }
            }
        }

        val runAs64 = preferences.getBoolean(PREF_RUN_AS_64_BITS, false)
        Log.d("ExploitHandler", "doInBackground: runAs64 = $runAs64")

        arrayOf(
            "getprop ro.vendor.product.model",
            "getprop ro.build.version.release",
            "date",
            "ls -R -1 -h -g ${context.filesDir.absolutePath}",
            "cat /proc/cpuinfo", "cat /proc/meminfo",
            "free", "cat /proc/version",
            "sh ${context.filesDir.absolutePath}/magisk-boot.sh ${if (runAs64) "64" else "32"}"
        ).forEach { command ->
            try {
                Log.d("ExploitHandler", "doInBackground: Executing command: $command")
                log.append(Runtime.getRuntime().exec(command).getOutput())
            } catch (e: Exception) {
                log.append(e.message)
                Log.e("ExploitHandler", "doInBackground: Failed to execute command: $command", e)
            }
        }

        val isSuccessful = File("/sbin/su").exists()
        Log.d("ExploitHandler", "doInBackground: isSuccessful = $isSuccessful")

        try {
            files.forEach { file ->
                file.deleteRecursively().let { success ->
                    if (success) {
                        log.append("deleted ${file.toRelativeString(context.filesDir)}\n")
                        Log.d("ExploitHandler", "doInBackground: Deleted file: ${file.toRelativeString(context.filesDir)}")
                    }
                }
            }
        } catch (e: Exception) {
            log.append(e.message)
            Log.e("ExploitHandler", "doInBackground: Failed to delete files", e)
        }
        
        Log.d("ExploitHandler", "doInBackground: Execution completed")
        return ExploitResult(isSuccessful, log.toString())
    }

}